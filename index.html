
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Illume Feedback Survey</title>
<style>
  :root { --bg:#0f1115; --card:#171a21; --ink:#e6e6ea; --muted:#a9abb3; --gold:#c3985a; --bad:#e5534b; --okay:#3fb950; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  .wrap { max-width:960px; margin:24px auto; padding:0 16px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  h1 { font-size:28px; margin:0; color:var(--gold); letter-spacing:.3px; }
  .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.3); }
  .row { display:grid; grid-template-columns:1fr; gap:14px; }
  label { display:block; font-weight:600; margin-bottom:6px; }
  select, input[type="text"], input[type="email"], textarea { width:100%; background:#0d0f14; border:1px solid #2a2f3a; color:var(--ink); border-radius:10px; padding:10px 12px; outline:none; }
  textarea { min-height:96px; resize:vertical; }
  .pill { display:inline-flex; align-items:center; gap:6px; background:#0d0f14; border:1px solid #2a2f3a; border-radius:999px; padding:8px 12px; user-select:none; }
  .pill input[type="checkbox"] { appearance:auto; accent-color:var(--gold); }
  .choices { display:flex; gap:8px; flex-wrap:wrap; }
  .subtle { color:var(--muted); font-size:12px; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
  button { background:var(--gold); color:#111; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
  button.secondary { background:#0d0f14; color:var(--ink); border:1px solid #2a2f3a; }
  button.warn { background:#e5534b; color:#fff; }
  .hide { display:none !important; }
  .req { color:var(--bad); margin-left:6px; font-weight:700; }
  .inline-input { display:inline-block; width:220px; vertical-align:middle; margin-left:8px; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; }
  .modal { background:#12151c; border:1px solid #2a2f3a; border-radius:16px; max-width:520px; width:100%; padding:18px; box-shadow:0 10px 32px rgba(0,0,0,.4); }
  .modal h2 { margin:0 0 8px 0; color:var(--okay); }
  .modal .muted { color:var(--muted); font-size:12px; }
  .admin-note { font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Illume Feedback Survey</h1>
    <div class="subtle">Choose your customer type to see relevant questions.</div>
  </header>

  <div class="card">
    <div class="row">
      <!-- Optional identity fields -->
      <div class="row">
        <div>
          <label>First name</label>
          <input id="firstName" type="text" placeholder="First name (optional)">
        </div>
        <div>
          <label>Last name</label>
          <input id="lastName" type="text" placeholder="Last name (optional)">
        </div>
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com (optional)">
        </div>
      </div>

      <div>
        <label for="role">Which best describes you? <span class="req">*</span></label>
        <select id="role" required>
          <option value="">Select...</option>
          <option>Magazine Advertiser</option>
          <option>Magazine Subscriber</option>
          <option>Event Attendee</option>
          <option>Event Instructor</option>
          <option>Event Vendor</option>
          <option>Learn Instructor</option>
          <option>Learn Subscriber</option>
        </select>
      </div>

      <div id="formFields" class="row"></div>

      <div class="actions">
        <button id="submitBtn">Submit Response</button>

        <!-- Admin controls hidden by default -->
        <span id="adminControls" class="hide" style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="secondary" id="exportCsvBtn">Export CSV</button>
          <button class="secondary" id="exportJsonBtn">Export JSON</button>
          <button class="secondary" id="importJsonBtn">Import JSON</button>
          <button class="warn" id="clearBtn">Clear Stored Responses</button>
        </span>
      </div>
      <div class="subtle">Responses save in this browser. Export before clearing cache or switching devices.</div>
      <div id="adminHint" class="admin-note hide">Admin mode enabled.</div>
    </div>
  </div>
</div>

<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <h2>Thanks â€” your response has been submitted</h2>
    <div id="confirmBody"></div>
    <p class="muted">You can close this window or submit another entry.</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="closeModal">Close</button>
      <button class="secondary" id="downloadCsvQuick">Download CSV</button>
    </div>
  </div>
</div>

<script>
// ===== Admin mode toggle =====
// Change this to your own passphrase
const ADMIN_PASSPHRASE = "sunset-saddle";
const ADMIN_FLAG_KEY = "illume_admin_mode";

function setAdminMode(on){
  localStorage.setItem(ADMIN_FLAG_KEY, on ? "1" : "0");
  document.getElementById("adminControls").classList.toggle("hide", !on);
  document.getElementById("adminHint").classList.toggle("hide", !on);
}

// Enable via Shift+A then passphrase prompt
document.addEventListener("keydown", (e)=>{
  if(e.key.toLowerCase() === "a" && e.shiftKey){
    const input = prompt("Enter admin passphrase:");
    if(input && input.trim() === ADMIN_PASSPHRASE){
      setAdminMode(true);
      alert("Admin mode enabled");
    } else if(input != null) {
      alert("Incorrect passphrase");
    }
  }
});

// Also allow URL hash: #admin=pass
(function(){
  const m = location.hash.match(/#admin=(.+)$/);
  if(m && decodeURIComponent(m[1]) === ADMIN_PASSPHRASE) setAdminMode(true);
  else setAdminMode(localStorage.getItem(ADMIN_FLAG_KEY) === "1");
})();

// ===== Survey schema =====
const schema = {
  "Magazine Subscriber": [
    { key:"mag_sat",       label:"On a scale of 1-5, how satisfied are you with Illume Magazine?", type:"scale5" },
    { key:"mag_enjoy",     label:"What do you enjoy most about the magazine?", type:"checkbox",
      options:["Historical pieces","Business tips","Artisan spotlights","Industry news","Skill demonstrations","Supplier connections"], other:true },
    { key:"mag_format",    label:"Do you prefer reading the magazine in the print or digital format?", type:"single",
      options:["Print","Digital","Both"] },
    { key:"mag_reco",      label:"How likely are you to recommend Illume to a fellow leatherworker?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] }
  ],
  "Magazine Advertiser": [
    { key:"adv_sat",       label:"How satisfied are you with your advertising experience with Illume?", type:"scale5" },
    { key:"adv_lift",      label:"Have you noticed an increase in customer inquiries or sales from your ad?", type:"yesno" },
    { key:"adv_again",     label:"How likely are you to advertise with us again?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"adv_improve",   label:"What could we improve to make advertising with Illume more valuable to you?", type:"text" }
  ],
  "Learn Subscriber": [
    { key:"learn_sat",     label:"How satisfied are you with your Learn with Illume experience?", type:"scale5" },
    { key:"learn_chooser", label:"What determines your course selection most of the time?", type:"single",
      options:["Skill level","Project type","Instructor"], other:true },
    { key:"learn_freq",    label:"How often are you in the platform?", type:"single",
      options:["Daily","Weekly","Monthly","Rarely"] },
    { key:"learn_renew",   label:"How likely are you to continue your subscription next month?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"learn_better",  label:"What is one thing that could improve your learning experience on Illume?", type:"text" }
  ],
  "Learn Instructor": [
    { key:"teach_sat",     label:"How satisfied are you with your experience as an instructor on Learn with Illume?", type:"scale5" },
    { key:"teach_process", label:"How is the process of outlining and filming courses with the Illume team?", type:"scale5" },
    { key:"teach_engage",  label:"Have you seen engagement from students in your courses?", type:"yesno" },
    { key:"teach_reco",    label:"Would you recommend teaching on Learn with Illume to other leather professionals?", type:"single",
      options:["Yes","No"] },
    { key:"teach_why_no",  label:"If no, why?", type:"text", showIf:{ field:"teach_reco", equals:"No" } },
    { key:"teach_support", label:"What support or resources would help you create better courses?", type:"text" }
  ],
  "Event Attendee": [
    { key:"evt_sat",       label:"How satisfied were you with the event?", type:"scale5" },
    { key:"evt_best",      label:"What part of the event did you enjoy the most?", type:"single",
      options:["Vendor hall","Competitions","Classes","Networking","Post-show events","Event staff"], other:true },
    { key:"evt_class",     label:"Did you attend a class?", type:"single",
      options:["No","Yes"] },
    { key:"evt_class_rate",label:"If yes, how would you rate it?", type:"scale5",
      showIf:{ field:"evt_class", equals:"Yes" } },
    { key:"evt_return",    label:"How likely are you to attend again next year?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] }
  ],
  "Event Vendor": [
    { key:"ven_sat",       label:"How satisfied were you with your vending experience?", type:"scale5" },
    { key:"ven_goal",      label:"Did you meet your sales expectations?", type:"yesno" },
    { key:"ven_aud",       label:"What type of attendees were most interested in your products?", type:"checkbox",
      options:["Hobbyists","Small business owners","Manufacturers"], other:true },
    { key:"ven_again",     label:"How likely are you to return as a vendor next year?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"ven_improve",   label:"What would improve your experience as a vendor?", type:"text" }
  ],
  "Event Instructor": [
    { key:"einst_sat",     label:"How satisfied were you with your teaching experience at the event?", type:"scale5" },
    { key:"einst_eng",     label:"Did your class meet or exceed your expectations for engagement?", type:"yesno" },
    { key:"einst_next",    label:"Would you be interested in teaching again next year?", type:"yesno" },
    { key:"einst_reco",    label:"How likely are you to recommend teaching at our events to other leather industry professionals?", type:"scale5" }
  ]
};

const STORAGE_KEY = "illume_feedback_responses_framework_v2";
const responses = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

const $ = (sel) => document.querySelector(sel);
const roleSel = $("#role");
const formFields = $("#formFields");

function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function makeSelect(options, placeholder="Select..."){
  const s = document.createElement("select");
  const ph = document.createElement("option");
  ph.value = ""; ph.textContent = placeholder;
  s.appendChild(ph);
  options.forEach(opt => { const o = document.createElement("option"); o.textContent = opt; s.appendChild(o); });
  return s;
}
function makeScale5(){ return makeSelect(["1","2","3","4","5"], "1 to 5"); }
function makeYesNo(){ return makeSelect(["Yes","No"], "Yes or No"); }

function makeCheckboxPills(options, other){
  const wrap = document.createElement("div"); wrap.className = "choices";
  options.forEach(opt => {
    const pill = document.createElement("label"); pill.className = "pill";
    const input = document.createElement("input"); input.type = "checkbox"; input.value = opt;
    pill.appendChild(input); pill.appendChild(document.createTextNode(opt));
    wrap.appendChild(pill);
  });
  if(other){
    const pill = document.createElement("label"); pill.className = "pill";
    const input = document.createElement("input"); input.type = "checkbox"; input.value = "__OTHER__";
    const txt = document.createElement("input"); txt.type = "text"; txt.className = "inline-input"; txt.maxLength = 100; txt.placeholder = "Other (max 100 chars)";
    pill.appendChild(input); pill.appendChild(document.createTextNode("Other")); pill.appendChild(txt);
    wrap.appendChild(pill);
  }
  return wrap;
}
function getCheckboxValues(wrap){
  const vals = [];
  wrap.querySelectorAll("label").forEach(l => {
    const cb = l.querySelector('input[type="checkbox"]');
    if(cb && cb.checked){
      if(cb.value === "__OTHER__"){
        const t = l.querySelector('input[type="text"]');
        if(t && t.value.trim()) vals.push(t.value.trim());
      } else {
        vals.push(cb.value);
      }
    }
  });
  return vals;
}

function renderField(def){
  const holder = document.createElement("div");
  holder.dataset.key = def.key;
  holder.dataset.required = (def.required === false ? "false" : "true");
  const label = document.createElement("label"); label.innerHTML = def.label + ' <span class="req">*</span>';
  holder.appendChild(label);
  let control;
  if(def.type === "scale5") control = makeScale5();
  else if(def.type === "single") {
    control = makeSelect([...(def.options||[]), ...(def.other?["Other"]:[])]);
    if(def.other){
      const otherBox = document.createElement("input"); otherBox.type="text"; otherBox.className="inline-input hide"; otherBox.maxLength=100; otherBox.placeholder="Other (max 100 chars)";
      control.addEventListener("change", ()=>{
        if(control.value === "Other") otherBox.classList.remove("hide");
        else { otherBox.value = ""; otherBox.classList.add("hide"); }
      });
      holder.appendChild(control);
      holder.appendChild(otherBox);
      control.dataset.otherInputId = Math.random().toString(36).slice(2);
      otherBox.dataset.bindTo = control.dataset.otherInputId;
      return holder;
    }
  }
  else if(def.type === "yesno") control = makeYesNo();
  else if(def.type === "text") { control = document.createElement("textarea"); control.placeholder = "Type your answer"; }
  else if(def.type === "checkbox") control = makeCheckboxPills(def.options || [], !!def.other);
  else control = document.createElement("input");
  if(control) control.dataset.type = def.type;
  holder.appendChild(control);
  if(def.showIf){ holder.dataset.showIf = JSON.stringify(def.showIf); holder.classList.add("hide"); }
  return holder;
}

function evaluateVisibility(){
  const map = {};
  formFields.querySelectorAll("[data-key]").forEach(block => {
    const key = block.dataset.key;
    const select = block.querySelector("select");
    const area = block.querySelector("textarea");
    const choices = block.querySelector(".choices");
    let value = "";
    if(select){ value = select.value; }
    else if(area){ value = area.value; }
    else if(choices){ value = getCheckboxValues(choices).join("; "); }
    map[key] = value;
  });
  formFields.querySelectorAll("[data-key]").forEach(block => {
    const rule = block.dataset.showIf ? JSON.parse(block.dataset.showIf) : null;
    if(!rule){ block.classList.remove("hide"); return; }
    const current = map[rule.field] || "";
    if(current === rule.equals) block.classList.remove("hide");
    else block.classList.add("hide");
  });
}

function renderForm(){
  clearChildren(formFields);
  const role = roleSel.value;
  if(!role || !schema[role]) return;
  schema[role].forEach(def => formFields.appendChild(renderField(def)));
  formFields.addEventListener("input", evaluateVisibility, { once:true });
  formFields.addEventListener("change", evaluateVisibility);
  evaluateVisibility();
}

roleSel.addEventListener("change", renderForm);

function validateAndCollect(){
  const role = roleSel.value;
  if(!role){ alert("Please choose your customer type first."); return null; }

  const out = { _ts:new Date().toISOString(), role };

  // Optional identity fields
  out.first_name = (document.getElementById("firstName").value || "").trim();
  out.last_name  = (document.getElementById("lastName").value || "").trim();
  out.email      = (document.getElementById("email").value || "").trim();

  let ok = true, problems = [];

  formFields.querySelectorAll("[data-key]").forEach(block => {
    const hidden = block.classList.contains("hide");
    if(hidden) return; // ignore hidden
    const key = block.dataset.key;
    const required = block.dataset.required !== "false";
    const select = block.querySelector("select");
    const area = block.querySelector("textarea");
    const choices = block.querySelector(".choices");

    let value = "";
    if(select){
      value = select.value.trim();
      if(select.dataset.otherInputId){
        const match = formFields.querySelector(`input.inline-input[data-bind-to="${select.dataset.otherInputId}"]`);
        if(select.value === "Other"){
          const v = match.value.trim();
          if(v.length === 0) { ok = false; problems.push(block); }
          value = v;
        }
      }
    } else if(area){ value = area.value.trim(); }
    else if(choices){
      const vals = getCheckboxValues(choices);
      value = vals.join("; ");
      if(required && vals.length === 0) { ok = false; problems.push(block); }
    }

    if(required && !choices && !value){ ok = false; problems.push(block); }

    out[key] = value;
  });

  if(!ok){
    problems[0]?.scrollIntoView({ behavior:"smooth", block:"center" });
    alert("Please complete all required fields.");
    return null;
  }
  return out;
}

// ===== Storage and export =====
function toCSV(rows){
  if(rows.length === 0) return "";
  const cols = Array.from(rows.reduce((set,row)=>{ Object.keys(row).forEach(k=>set.add(k)); return set; }, new Set()));
  const esc = v => {
    const s = String(v==null ? "" : v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  const header = cols.map(esc).join(",");
  const body = rows.map(r => cols.map(c => esc(r[c]||"")).join(",")).join("\n");
  return header + "\n" + body;
}
function normalizedJSON(rows){
  const byRole = {};
  for(const r of rows){
    const role = r.role || "Unknown";
    if(!byRole[role]) byRole[role] = [];
    const sorted = Object.keys(r).sort().reduce((o,k)=>{ o[k]=r[k]; return o; }, {});
    byRole[role].push(sorted);
  }
  const totals = Object.fromEntries(Object.entries(byRole).map(([k,v])=>[k,v.length]));
  return { exported_at:new Date().toISOString(), total:rows.length, totals_by_role:totals, by_role:byRole };
}
function download(data, filename, type){
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// ===== Modal =====
function openModal(summaryHtml){
  const bd = document.getElementById("backdrop");
  const body = document.getElementById("confirmBody");
  body.innerHTML = summaryHtml;
  bd.style.display = "flex";
}
function closeModal(){ document.getElementById("backdrop").style.display = "none"; }
document.getElementById("closeModal").addEventListener("click", closeModal);
document.getElementById("downloadCsvQuick").addEventListener("click", ()=>{
  const csv = toCSV(responses);
  if(!csv){ alert("No responses yet."); return; }
  download(csv, "illume_responses.csv", "text/csv");
});

// ===== Buttons =====
document.getElementById("submitBtn").addEventListener("click", ()=>{
  const row = validateAndCollect(); if(!row) return;
  responses.push(row);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(responses));

  const who = [row.first_name, row.last_name].filter(Boolean).join(" ");
  const summary = `<p><strong>Submitted</strong> at ${new Date(row._ts).toLocaleString()}<br><strong>Customer type:</strong> ${row.role}${who ? "<br><strong>Name:</strong> " + who : ""}${row.email ? "<br><strong>Email:</strong> " + row.email : ""}</p>`;
  openModal(summary);

  // reset visible controls
  formFields.querySelectorAll("select").forEach(s=>s.value="");
  formFields.querySelectorAll("textarea").forEach(t=>t.value="");
  formFields.querySelectorAll(".choices input[type=checkbox]").forEach(c=>c.checked=false);
  formFields.querySelectorAll(".inline-input").forEach(t=>{ t.value=""; t.classList.add("hide"); });
  // keep identity fields as typed for convenience
});

// Admin-only actions
document.getElementById("exportCsvBtn").addEventListener("click", ()=>{
  const csv = toCSV(responses);
  if(!csv){ alert("No responses yet."); return; }
  download(csv, "illume_responses.csv", "text/csv");
});
document.getElementById("exportJsonBtn").addEventListener("click", ()=>{
  const obj = normalizedJSON(responses);
  download(JSON.stringify(obj, null, 2), "illume_responses.json", "application/json");
});
document.getElementById("importJsonBtn").addEventListener("click", ()=>{
  const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try {
        const data = JSON.parse(reader.result);
        const rows = Array.isArray(data) ? data : (data.by_role ? Object.values(data.by_role).flat() : []);
        if(!rows || rows.length === 0) throw new Error("No rows found in JSON");
        responses.length = 0; rows.forEach(r=>responses.push(r));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(responses));
        alert("Imported");
      } catch(err){ alert("Import failed: " + err.message); }
    };
    reader.readAsText(file);
  };
  inp.click();
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(confirm("Remove all locally stored responses?")) {
    localStorage.removeItem(STORAGE_KEY);
    alert("Cleared");
    location.reload();
  }
});
</script>
</body>
</html>
